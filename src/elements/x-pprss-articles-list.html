<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="x-pprss-article.html">
<polymer-element name="x-pprss-articles-list" attributes="articles client holderItem">
  <template>
  <core-list fit id="articles" data="{{articles}}">
    <template>
    <x-pprss-article data-index="{{index}}" article="{{model}}">
      </x-pprss-article>
    </template>
  </core-list>
  </template>
  <script>
    (function(){
    function makeItem(client, holder_item, item){
      item.uid = holder_item.uid + '/' + item.id;
      //item.article = new Article(client, item);

      return item;
    }

    Polymer('x-pprss-articles-list', {
      articles: [],
      client: {},
      holderItem: {},

      req: null,
      ready: function(){
      },
      domReady: function(){
      },

      abort: function(){
        if(this.req !== null){
          this.req.abort();
          this.req = null;
        }
      },

      fetchArticles: function(){
        this.fire('fetch-start');
        this.abort();

        var that = this;
        this.req = this.fetchItems(function(err, items){
          that.req = null;
          that.fire('fetch-complete', {err: err});
        });
      },
      fetchItems: function(caller_cb){
        var that = this;
        var aborted = false;
        req = this.client.get_headlines({
          feed_id: this.holderItem.id,
          is_cat: this.holderItem.kind == 'cat',
          show_excerpt: false,
          show_content: true,
          include_attachments: true,
          view_mode: this.holderItem.unread > 0 ? 'unread' : 'all_articles'},
          function(err, headlines){
            req = null;
            if(aborted){
              err = new Error('abort');
            }
            if(!err){
              that.items = headlines;
              var len = that.items.length;
              for(var idx = 0; idx < len; idx++){
                that.items[idx] = makeItem(that.client, that.holderItem, that.items[idx]);
              }
              caller_cb(err, that.items);
              that.articles = that.items;
              that.fire('items-changed', {items: that.items});
            }else{
              caller_cb(err);
            }
          }
        );
        return {
          abort: function(){
            aborted = true;
            // TODO: `Uncaught TypeError: undefined is not a function` in `Request.prototype.abort`
            // if(req !== null){
            //   req.abort();
            // }
          }
        };
      },
      markAsRead: function(holderItem){
        if(this.holderItem.uid === holderItem.uid){
          var len = this.items.length;
          for(var idx = 0; idx < len; idx++){
            this.items[idx].unread = false;
          }
          //this.holderItem.unread = 0;

          var pos = this.$.articles.getScrollTop();
          this.articles = [];
          var that = this;
          this.async(function(){
            that.articles = that.items;
            that.$.articles.setScrollTop(pos);
            that.fire('mark-as-read', {holderItem: that.holderItem, items: that.items});
          });
        }else{
          this.fire('mark-as-read', {holderItem: holderItem, items: []});
        }
      },
      scrollToItem: function(index){
        this.$.articles.scrollToItem(index);
      }
    });
    })();
  </script>
</polymer-element>
