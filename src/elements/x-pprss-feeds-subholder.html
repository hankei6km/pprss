<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="x-pprss-items-util.html">
<link rel="import" href="x-pprss-number-badge.html">
<polymer-element name="x-pprss-feeds-subholder" attributes="items active opened">
  <template>
  <style>
    core-menu {
      margin: 0px;
    }
    #expander {
      color: gray;
    }
    .subitem {
      margin-left: 2.5em
    }
    .core-selected core-item{
      font-weight: bold;
    }
    core-item /deep/ #label { /* dependent structure of core-item. */
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
  </style>
  <div horizontal layout>
    <core-item id="expander" icon="{{opened ? iconLess: iconMore}}" on-tap="{{handleToggleTap}}">
    </core-item>
    <core-item id="label" label="{{catItem.title}}" class="{{labelClass}}" flex on-tap="{{handleLabelTap}}">
    </core-item>
    <x-pprss-number-badge number="{{catItem.unread}}"></x-pprss-number-badge>
  </div>
  <core-collapse id="subitems" opened=false on-core-resize="{{handleResize}}">
    <core-menu id="menu" theme="core-light-theme" selected="-1" itemsSelector="div[class=subitem]" on-core-select="{{handleItemSelect}}">
      <template repeat="{{feedItem in feedItems}}">
        <div class="subitem" data="{{feedItem.uid}}" horizontal layout>
          <core-item label="{{feedItem.title}}" flex></core-item>
          <x-pprss-number-badge number="{{feedItem.unread}}"></x-pprss-number-badge>
        </div>
      </template>
    </core-menu>
  </core-collapse>
  <x-pprss-items-util id="itemsUtil"></x-pprss-items-util>
  </template>
  <script>
    (function(){
    var template = document.querySelector('template');
    Polymer('x-pprss-feeds-subholder', {
      items: [],
      catItem: {},
      feedItems: [],
      active: false,
      opened: false,
      labelClass: '',
      iconLess: 'expand-more',
      iconMore: 'chevron-right',
      ready: function(){
      },
      domReady: function(){
      },
      handleToggleTap: function(e){
        this.$.subitems.toggle();
        this.opened = !(this.opened);
        // TODO: stop to select item.
        e.preventDefault();
      },
      handleLabelTap: function(e){
        this.labelClass = 'core-selected';
        this.$.menu.selected = -1;
        this.fire('select', {
          uid: this.items[0].uid
        });
      },
      handleResize: function(e){
        this.opened = this.$.subitems.opened;
      },
      handleItemSelect: function(e){
        if(e.detail.isSelected){
          this.labelClass = '';
          this.fire('select', {
            uid: e.detail.item.getAttribute('data')
          });
        }
      },
      activeChanged: function(oldValue, newValue){
        if(newValue){
        }else{
          this.labelClass = '';
          this.$.menu.selected = -1;
          this.$.subitems.opened = false;
        }
      },
      itemsChanged: function(oldValue, newValue){
        if(newValue && newValue.length > 0){
          this.catItem = newValue[0];
          this.feedItems = newValue.slice(1);
        }else{
          this.catItem = {};
          this.feedItems = [];
        }
      }
    });
    })();
  </script>
</polymer-element>
